# BanditPAM: Almost Linear-Time $k$-Medoids Clustering

## Dear Reviewer

We thank you for your time in reviewing our submission.
We understand that you are performing a service to the community.
In order to ensure that review of this code is as easy as possible, we have:
- Heavily commented and documented the code
- Included an overview of the codebase and the files
- Described in detail how to reproduce our results.

Thank you for reviewing our submission!

If you have any difficulties, please see the platform-specific guides in the `docs` folder (i.e `docs/install_*.md`).

# Introduction

Throughout this repo, an "experiment" refers to a specific $k$-medoids problem
we wish to solve. Each experiment in this repository is specified by a number of
parameters:
- algorithm (bfp, also known as BanditFasterPAM, fp, also known as FasterPAM, or naive_v1, which refers to PAM)
- num_medoids (k, e.g. 5)
- dataset subsample size (N, e.g. 20,000)
- dataset (e.g. MNIST)
- random seed (e.g. 42)
- metric (e.g. L2)

When an experiment is conducted, the C++ code of an algorithm is run and we take note
of statistics such as the number of distance computations, swaps steps, and wall clock 
time.

Logfiles are written for every plotting experiment. These logfiles contain
information about the medoids assigned after the BUILD step (or uniform random sampling),
the final medoids chosen after the SWAP step, the final loss, the number of swaps performed,
and the number of distance computations made. Timefiles are written for Fig 2 (a) - 3 (b).
The logfiles are prefixed with `L-` and timefiles are prefixed with `t-`.

All logfiles and timefiles necessary to recreate the plots in the paper are
provided in the `/python_generate_plots/logs/` directory. We also include instructions on how to
create these logfiles and timefiles from scratch (see below).

# Requirements

This code requires `python >= 3.7` and `pip >= 20.1.1`. All other packages are
in `requirements.txt` and can be installed via `python -m pip install -r requirements.txt`.

If you are using a virtualenv, please ensure that you are able to run
`python --version` and `python -m pip --version` from your virtualenv. There are known
issues with virtualenvs on macOS, unrelated to this work (for example, openssl
errors that manifest with errors like `cannot import name md5`). See
https://stackoverflow.com/questions/59123154/importerror-cannot-import-name-md5

## BanditFasterPAM vs. BanditPAM++ Comparison
- Run `chmod +x comparison.sh && ./comparison.sh`
- The script will install this package's requirements, install the package itself, download necessary datasets, and run the experiment.
  - Note: Installing the Python wheels on an M1 Mac is currently unsupported. If you encounter this issue, we recommend installing the package from source as noted in `docs/install_mac.md`.

## Required Datasets

A number of datasets are required to recreate the plots from the paper. See
below for instructions on how to acquire the datasets.

### MNIST

`python -m pip install mnist` will install the `mnist` python package from
https://pypi.org/project/mnist/ and will enable loading of the MNIST dataset.

### SCRNA

The single-cell RNA (SCRNA) sequence dataset used in the paper can be downloaded
using the `chmod +x comparison.sh && ./comparison.sh` command mentioned above.

### CIFAR-10

`python -m pip install tensorflow` will install the `tensorflow` python package
and, therefore, the `cifar10` dataset from Keras.

# Running Multiple Experiments

It is possible to run multiple experiments at once to obtain their logfiles and timefiles.
`run_experiments.py` takes in an experiment config,
which contains a list of experiments to run, and will run each of them.

To generate an experiment config programmatically, use `python generate_config.py`.
The auto-generated config will be stored in `auto_exp_config.py`. Different sets
of experiments (e.g. for MNIST, SCRNA, etc.) can be generated by (un)commenting
the relevant lines of `generate_config.py`. All of the experiments can then be
run via:

`python run_experiments.py -e auto_exp_config.py`

Note that the `output_dir` variable in `run_experiments.py` can be modified to change the directory the
logfiles and timefiles are stored in.

# Creating The Figures

All of the necessary logfiles and timefiles to recreate the figures from the paper are already
included in this zip archive. Instructions on recreating each plot are below:

To remake Figure 1(a), run `python make_loss_plots.py`. This retrieves the final
losses for each algorithm from the corresponding logfiles.

To remake Figures 1(b) - 3(b), run `python parse_logs.py`, (un)commenting
the code for the necessary specific set of experiments in `main()` and changing
the `dir_` variable to where the logfiles and timefiles are stored.

# Information About Each File

## Algorithms
- `src/algorithms/banditfasterpam.cpp` : implementation of BanditFasterPAM
- `src/algorithms/banditpam.cpp` : implementation of BanditPAM++
- `src/algorithms/banditpam_orig.cpp` : implementation of BanditPAM
- `src/algorithms/fasterpam.cpp` : implementation of FasterPAM
- `src/algorithms/fastpam1.cpp` : implementation of FastPAM1
- `src/algorithms/kmedoids_algorithm.cpp` : common code for all algorithms
- `src/algorithms/pam.cpp` : implementation of PAM
- `src/python_bindings`: python bindings for the C++ algorithms
- `src/main`: main function for running the C++ algorithms
- `headers/algorithms` and `headers/python_bindings`: headers for the C++ algorithms and python bindings

## Running plotting experiments
- `python_generate_plots/generate_config.py` : used to programatically generate a list of experiments
  to run
- `python_generate_plots/auto_exp_config.py`: experiment configs automatically generated by
  `python_generate_plots/generate_config.py`, for use with `python_generate_plots/run_experiments.py`
- `python_generate_plots/run_experiments.py` : runs the experiments listed in `python_generate_plots/auto_exp_config.py`
- `python_generate_plots/data_utils.py` : Common functions for data loading and argument retrieval
- `python_generate_plots/parse_logs.py` : Parses the logfiles and timefiles generated by `run_experiments.py` to create Fig 1 (b) - 3(b)
- `python_generate_plots/make_loss_plots.py` : Parses the logfiles generated by `run_experiments.py` to create Fig 1 (a)

## Running comparison experiment
- `comparison.sh` : Bash script to run the comparison
- `scripts/compare_banditpam_versions.py`: Python script to compare BanditFasterPAM and BanditPAM++
- `scripts/comparison_utils.py`: Utility to print the result of different algorithms

## Miscellaneous
- `requirements.txt` : Specification of packages to install via
  `python -m pip install -r requirements.txt`
- `setup.py`: Used to install the python package locally via `python -m pip install .`
- `docs`: Contains platform-specific installation guides and a `.rst` description of the codebase
